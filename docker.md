# Docker

## Docker 是什么？

Docker 在容器的基础上，进行了进一步的封装，从文件系统、网络互联到进程隔离等等，极大的简化了容器的创建和维护。使得 Docker 技术比虚拟机技术更为轻便、快捷。

所谓容器，指的是基于 Linux 内核的 cgroup，namespace，以及 AUFS 类的 Union FS 等技术，对进程进行封装隔离，属于操作系统层面的虚拟化技术。由于隔离的进程独立于宿主和其它的隔离的进程，因此也称其为容器。

传统虚拟机技术是虚拟出一套硬件后，在其上运行一个完整操作系统，在该系统上再运行所需应用进程；而容器内的应用进程直接运行于宿主的内核，容器内没有自己的内核，而且也没有进行硬件虚拟。因此容器要比传统虚拟机更为轻便。

## 为什么要用 Docker

### 比虚拟机更快

由于容器不需要进行硬件虚拟以及运行完整操作系统等额外开销，Docker 对系统资源的利用率更高。无论是应用执行速度、内存损耗或者文件存储速度，都要比传统虚拟机技术更高效。因此，相比虚拟机技术，一个相同配置的主机，往往可以运行更多数量的应用。传统的虚拟机技术启动应用服务往往需要数分钟，而 Docker 容器应用，由于直接运行于宿主内核，无需启动完整的操作系统，因此可以做到秒级、甚至毫秒级的启动时间。大大的节约了开发、测试、部署的时间。

### 保持开发、测试、生产环境的一致

开发过程中一个常见的问题是环境一致性问题。由于开发环境、测试环境、生产环境不一致，导致有些 bug 并未在开发过程中被发现。而 Docker 的镜像提供了除内核外完整的运行时环境，确保了应用运行环境一致性，从而不会再出现 「这段代码在我机器上没问题啊」 这类问题。

## 安装 Docker

在 Docker 官网中下载安装软件，安装即可。安装成功后，可在终端调用如下命令：

```bash
docker --version
```

若能输出版本号，说明 Docker 安装成功。安装完成后，最好设置国内镜像站点<https://registry.docker-cn.com>信息，以加快镜像下载速度。

## Docker的几个核心概念

理解镜像、容器、仓库、数据卷等等基本概念，有助于了解 Docker 的整个生命周期。

### 镜像（Image）

操作系统分为内核和用户空间。对于 Linux 而言，内核启动后，会挂载 root 文件系统为其提供用户空间支持。而 Docker 镜像（Image），就相当于是一个 root 文件系统。

Docker 镜像是一个特殊的文件系统（利用 Union FS 技术的文件系统，由一组文件组成，而非一个个文件），除了提供容器运行时所需的程序、库、资源、配置等文件外，还包含了一些为运行时准备的一些配置参数（如匿名卷、环境变量、用户等）。镜像不包含任何动态数据，其内容在构建之后也不会被改变。

### 容器（Container）

镜像（Image）和容器（Container）的关系，就像是面向对象程序设计中的`类`和`实例`一样，镜像是静态的定义，容器是镜像运行时的实体。容器可以被创建、启动、停止、删除、暂停等。

容器的实质是进程，但与直接在宿主执行的进程不同，容器进程运行于属于自己的独立的命名空间。因此容器可以拥有自己的 root 文件系统、自己的网络配置、自己的进程空间，甚至自己的用户 ID 空间。容器内的进程是运行在一个隔离的环境里，使用起来，就好像是在一个独立于宿主的系统下操作一样。这种特性使得容器封装的应用比直接在宿主运行更加安全。

按照 Docker 最佳实践的要求，容器不应该向其存储层内写入任何数据，容器存储层要保持无状态化。所有的文件写入操作，都应该使用 数据卷（Volume）、或者绑定宿主目录，在这些位置的读写会跳过容器存储层，直接对宿主（或网络存储）发生读写，其性能和稳定性更高。

数据卷的生存周期独立于容器，容器消亡，数据卷不会消亡。因此，使用数据卷后，容器删除或者重新运行之后，数据却不会丢失。

### 数据卷（Volume）

数据卷是一个可供一个或多个容器使用的特殊目录，它绕过 UFS，可以提供很多有用的特性：

1. 数据卷可以在容器之间共享和重用
1. 对数据卷的修改会立马生效
1. 对数据卷的更新，不会影响镜像
1. 数据卷默认会一直存在，即使容器被删除

在容器内不应写入任何数据，故数据应该写入数据卷。

### 仓库（Repository）

镜像构建完成后，可以很容易的在当前宿主机上运行，但是，如果需要在其它服务器上使用这个镜像，我们就需要一个集中的存储、分发镜像的服务，Docker Registry 就是这样的服务。

一个 Docker Registry 中可以包含多个仓库（Repository）；每个仓库可以包含多个标签（Tag）；每个标签对应一个镜像。

通常，一个仓库会包含同一个软件不同版本的镜像，而标签就常用于对应该软件的各个版本。我们可以通过 <仓库名>:<标签> 的格式来指定具体是这个软件哪个版本的镜像。如果不给出标签，将以 latest 作为默认标签。

可以使用公开仓库，也可创建私有仓库。通过仓库，实现镜像的云端存储和分发。

## 使用镜像

镜像是创建容器的模板。

### 获取镜像

使用 pull 命令可从 Docker Hub 上获取官方提供的镜像，例如：

```bash
docker pull centos
```

将会输出：

```bash
Using default tag: latest
latest: Pulling from library/centos
8ba884070f61: Pull complete 
Digest: sha256:8d487d68857f5bc9595793279b33d082b03713341ddec91054382641d14db861
Status: Downloaded newer image for centos:latest
```

从输出信息可以看到，pull命令后如果不指定用户名，将会使用library作为用户名，软件的标签如未指定，将使用latest。

完整的获取镜像的命令如下：

```bash
docker pull [选项] [Docker Registry 地址[:端口号]/]仓库名[:标签]
```

获取镜像后，我们就能以这个镜像为基础创建容器。例如以上面的镜像centos为例，可以执行：

```bash
docker run -it centos
```

其中`-it`表示使用交互模式终端。进入终端后，就可以像实体机器一样继续操作了。

### 对镜像的常用命令

|                     命令                     |        含义        |
| -------------------------------------------- | ------------------ |
| docker image ls                              | 列出已经下载的镜像 |
| docker image rm [选项] <镜像1> [<镜像2> ...] | 删除本地镜像       |

### 使用 Dockerfile 定制镜像



## 学习资料

1. <https://docker_practice.gitee.io/>
2. <https://docs.docker.com/>
